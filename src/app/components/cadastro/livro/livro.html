<div class="container">
  <h2>Cadastro de Livro</h2>

  <form (ngSubmit)="onSubmit(livroForm)" #livroForm="ngForm">
    <div class="form-group">
      <label>Autores: * <small style="color: #666;">(selecione um ou mais)</small></label>
      <small *ngIf="tituloSelecionado && tituloSelecionado !== ''" style="display: block; color: #f97316; font-size: 11px; margin-bottom: 4px;">
        ‚ö†Ô∏è Autores definidos pelo t√≠tulo selecionado. Para alterar, remova a sele√ß√£o do t√≠tulo.
      </small>
      <input 
        type="text" 
        placeholder="üîç Buscar autor..."
        [(ngModel)]="termoBuscaAutor"
        (ngModelChange)="filtrarAutores()"
        [disabled]="!!(tituloSelecionado && tituloSelecionado !== '')"
        name="buscaAutor"
        style="margin-bottom: 8px; width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
      />
      <div class="checkbox-list-form" [class.disabled]="tituloSelecionado && tituloSelecionado !== ''">
        <div 
          *ngFor="let autor of autoresFiltrados" 
          class="checkbox-item"
          [class.selected]="isAutorSelecionado(autor.idAutor || autor.id)"
          [class.disabled]="tituloSelecionado && tituloSelecionado !== ''"
          (click)="toggleAutor(autor.idAutor || autor.id)">
          <input 
            type="checkbox" 
            [checked]="isAutorSelecionado(autor.idAutor || autor.id)"
            [disabled]="tituloSelecionado && tituloSelecionado !== ''"
            readonly
          />
          <span>{{ autor.nome }}</span>
        </div>
      </div>
      <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
        <small style="color: #666; font-size: 11px;">
          Selecionados: {{ autoresSelecionados.length }}
        </small>
      </div>
      <button 
        type="button" 
        class="btn-add-novo" 
        (click)="abrirModalNovoAutor()"
        [disabled]="tituloSelecionado && tituloSelecionado !== ''"
        style="margin-top: 8px; width: 100%;">
        ‚û• Cadastrar novo autor
      </button>
      <span *ngIf="carregandoAutores" style="font-size: 12px; color: #666;">
        Carregando autores...
      </span>
    </div>

    <div class="form-group">
      <label>Categorias: * <small style="color: #666;">(selecione uma ou mais)</small></label>
      <small *ngIf="tituloSelecionado && tituloSelecionado !== ''" style="display: block; color: #f97316; font-size: 11px; margin-bottom: 4px;">
        ‚ö†Ô∏è Categorias definidas pelo t√≠tulo selecionado. Para alterar, remova a sele√ß√£o do t√≠tulo.
      </small>
      <input 
        type="text" 
        placeholder="üîç Buscar categoria..."
        [(ngModel)]="termoBuscaCategoria"
        (ngModelChange)="filtrarCategorias()"
        [disabled]="!!(tituloSelecionado && tituloSelecionado !== '')"
        name="buscaCategoria"
        style="margin-bottom: 8px; width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
      />
      <div class="checkbox-list-form" [class.disabled]="tituloSelecionado && tituloSelecionado !== ''">
        <div 
          *ngFor="let categoria of categoriasFiltradas" 
          class="checkbox-item"
          [class.selected]="isCategoriaSelecionada(categoria.idCategoria || categoria.id)"
          [class.disabled]="tituloSelecionado && tituloSelecionado !== ''"
          (click)="toggleCategoria(categoria.idCategoria || categoria.id)">
          <input 
            type="checkbox" 
            [checked]="isCategoriaSelecionada(categoria.idCategoria || categoria.id)"
            [disabled]="tituloSelecionado && tituloSelecionado !== ''"
            readonly
          />
          <span>{{ categoria.nome }}</span>
        </div>
      </div>
      <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
        <small style="color: #666; font-size: 11px;">
          Selecionadas: {{ categoriasSelecionadas.length }}
        </small>
      </div>
      <button 
        type="button" 
        class="btn-add-novo" 
        (click)="abrirModalNovaCategoria()"
        [disabled]="tituloSelecionado && tituloSelecionado !== ''"
        style="margin-top: 8px; width: 100%;">
        ‚û• Cadastrar nova categoria
      </button>
      <span *ngIf="carregandoCategorias" style="font-size: 12px; color: #666;">
        Carregando categorias...
      </span>
    </div>

    <div class="form-group">
      <label for="titulo">T√≠tulo:</label>
      <input 
        type="text" 
        placeholder="üîç Buscar t√≠tulo..."
        [(ngModel)]="termoBuscaTitulo"
        (ngModelChange)="filtrarTitulos()"
        name="buscaTitulo"
        style="margin-bottom: 8px; width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
      />
      <select 
        id="titulo" 
        name="titulo" 
        [(ngModel)]="tituloSelecionado"
        (change)="onTituloChange($any($event.target).value)"
        required>
        <option value="">Selecione um t√≠tulo</option>
        <option *ngFor="let titulo of titulosFiltrados" [value]="titulo.idTitulo">
          {{ titulo.nome }}
        </option>
      </select>
      <button 
        type="button" 
        class="btn-add-novo" 
        (click)="abrirModalNovoTitulo()"
        style="margin-top: 8px; width: 100%;">
        ‚ûï Cadastrar novo t√≠tulo
      </button>
      <span *ngIf="carregandoTitulos" style="font-size: 12px; color: #666;">
        Carregando t√≠tulos...
      </span>
    </div>

    <div class="form-group">
      <label for="dataPublicacao">Data de Publica√ß√£o:</label>
      <input
        type="date"
        id="dataPublicacao"
        name="dataPublicacao"
        [(ngModel)]="livro.dataPublicacao"
        required
      />
    </div>

    <div class="form-group">
      <label for="editora">Editora:</label>
      <input 
        type="text" 
        placeholder="üîç Buscar editora..."
        [(ngModel)]="termoBuscaEditora"
        (ngModelChange)="filtrarEditoras()"
        name="buscaEditora"
        style="margin-bottom: 8px; width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
      />
      <select 
        id="editora" 
        name="editora" 
        [(ngModel)]="editoraSelecionada"
        (change)="onEditoraChange($any($event.target).value)"
        required>
        <option value="">Selecione uma editora</option>
        <option *ngFor="let editora of editorasFiltradas" [value]="editora.idEditora || editora.id">
          {{ editora.nome }}
        </option>
      </select>
      <button 
        type="button" 
        class="btn-add-novo" 
        (click)="abrirModalNovaEditora()"
        style="margin-top: 8px; width: 100%;">
        ‚ûï Cadastrar nova editora
      </button>
      <span *ngIf="carregandoEditoras" style="font-size: 12px; color: #666;">
        Carregando editoras...
      </span>
    </div>

    <div class="form-group">
      <label for="idioma">Idioma:</label>
      <input 
        type="text" 
        placeholder="üîç Buscar idioma..."
        [(ngModel)]="termoBuscaIdioma"
        (ngModelChange)="filtrarIdiomas()"
        name="buscaIdioma"
        style="margin-bottom: 8px; width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
      />
      <select 
        id="idioma" 
        name="idioma" 
        [(ngModel)]="idiomaSelecionado"
        (change)="onIdiomaChange($any($event.target).value)"
        required>
        <option value="">Selecione um idioma</option>
        <option *ngFor="let idioma of idiomasFiltrados" [value]="idioma.idIdioma || idioma.id">
          {{ idioma.nome }}
        </option>
      </select>
      <button 
        type="button" 
        class="btn-add-novo" 
        (click)="abrirModalNovoIdioma()"
        style="margin-top: 8px; width: 100%;">
        ‚ûï Cadastrar novo idioma
      </button>
      <span *ngIf="carregandoIdiomas" style="font-size: 12px; color: #666;">
        Carregando idiomas...
      </span>
    </div>

    <div class="form-group">
      <label for="paginas">Quantidade de P√°ginas:</label>
      <input type="number" id="paginas" name="paginas" [(ngModel)]="livro.qtdPaginas" placeholder="Ex: 320" required />
    </div>

    <div class="form-group">
      <label for="tipoCapa">Tipo de Capa:</label>
      <select id="tipoCapa" name="tipoCapa" [(ngModel)]="livro.tipoCapa" required>
        <option value="">Selecione o tipo de capa</option>
        <option value="dura">Capa dura</option>
        <option value="flexivel">Capa mole/flex√≠vel</option>
      </select>
    </div>

    <div class="form-group">
      <label for="tamanho">Tamanho do Livro:</label>
      <select id="tamanho" name="tamanho" [(ngModel)]="livro.tamanho" required>
        <option value="">Selecione o tamanho</option>
        <option value="pequeno">Pequeno</option>
        <option value="medio">M√©dio</option>
        <option value="grande">Grande</option>
      </select>
    </div>

    <div class="form-group">
      <label for="classificacao">Classifica√ß√£o Indicativa:</label>
      <select id="classificacao" name="classificacao" [(ngModel)]="livro.classificacao" required>
        <option value="">Selecione a classifica√ß√£o</option>
        <option value="l">Livre (L)</option>
        <option value="C10">10 anos</option>
        <option value="C12">12 anos</option>
        <option value="C14">14 anos</option>
        <option value="C16">16 anos</option>
        <option value="C18">18 anos</option>
      </select>
    </div>

    <div class="form-group">
      <label for="edicao">Descri√ß√£o da Edi√ß√£o:</label>
      <input 
        type="text" 
        id="edicao" 
        name="edicao" 
        [(ngModel)]="livro.descricaoEdicao"
        placeholder="Ex: 1¬™ edi√ß√£o, Revisada, Ampliada..."
        maxlength="60"
        required />
      <small style="color: #666; font-size: 12px;">M√°ximo 60 caracteres</small>
    </div>

    <div class="form-group">
      <label for="imagem">Imagem do livro:</label>
      <input 
        type="file" 
        id="imagem" 
        name="imagem" 
        accept="image/*"
        (change)="onImagemChange($event)" />
      <small style="color: #666; font-size: 12px;">Formatos aceitos: JPG, PNG, GIF. Tamanho m√°ximo: 5MB</small>
    </div>

    <div style="margin-top: 20px; display: flex; justify-content: center; gap: 10px;">
      <button type="button" (click)="cancelar()">Cancelar</button>
      <button type="submit">Salvar</button>
    </div>
  </form>


  <div *ngIf="mostrarModalTitulo" class="modal-overlay" (click)="fecharModalTitulo()">
    <div class="modal-content modal-titulo" (click)="$event.stopPropagation()">
      <h3>Cadastrar Novo T√≠tulo</h3>
      
      <div class="form-group">
        <label for="novoTituloNome">Nome do T√≠tulo: *</label>
        <input 
          type="text" 
          id="novoTituloNome" 
          name="novoTituloNome"
          [(ngModel)]="novoTitulo.nome"
          placeholder="Digite o nome do t√≠tulo"
          required
        />
      </div>

      <div class="form-group">
        <label for="novoTituloDescricao">Descri√ß√£o do T√≠tulo: *</label>
        <textarea 
          id="novoTituloDescricao" 
          name="novoTituloDescricao"
          [(ngModel)]="novoTitulo.descricao"
          placeholder="Descreva brevemente o t√≠tulo"
          rows="4"
          required
        ></textarea>
      </div>

      <div class="form-group">
        <label>Autores: * <small style="color: #666;">(selecione um ou mais)</small></label>
        <input 
          type="text" 
          placeholder="üîç Buscar autor..."
          [(ngModel)]="termoBuscaAutorTitulo"
          (ngModelChange)="filtrarAutoresTitulo()"
          name="buscaAutorTitulo"
          style="margin-bottom: 8px; width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
        />
        <div class="checkbox-list">
          <div 
            *ngFor="let autor of autoresFiltradosTitulo" 
            class="checkbox-item"
            [class.selected]="isAutorSelecionadoNoTitulo(autor.idAutor || autor.id)"
            (click)="toggleAutorNoTitulo(autor.idAutor || autor.id)">
            <input 
              type="checkbox" 
              [checked]="isAutorSelecionadoNoTitulo(autor.idAutor || autor.id)"
              readonly
            />
            <span>{{ autor.nome }}</span>
          </div>
        </div>
        <small style="color: #666; font-size: 11px;">
          Selecionados: {{ novoTitulo.idsAutores.length }}
        </small>
      </div>

      <div class="form-group">
        <label>Categorias: * <small style="color: #666;">(selecione uma ou mais)</small></label>
        <input 
          type="text" 
          placeholder="üîç Buscar categoria..."
          [(ngModel)]="termoBuscaCategoriaTitulo"
          (ngModelChange)="filtrarCategoriasTitulo()"
          name="buscaCategoriaTitulo"
          style="margin-bottom: 8px; width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
        />
        <div class="checkbox-list">
          <div 
            *ngFor="let categoria of categoriasFiltradasTitulo" 
            class="checkbox-item"
            [class.selected]="isCategoriaSelecionadaNoTitulo(categoria.idCategoria || categoria.id)"
            (click)="toggleCategoriaNoTitulo(categoria.idCategoria || categoria.id)">
            <input 
              type="checkbox" 
              [checked]="isCategoriaSelecionadaNoTitulo(categoria.idCategoria || categoria.id)"
              readonly
            />
            <span>{{ categoria.nome }}</span>
          </div>
        </div>
        <small style="color: #666; font-size: 11px;">
          Selecionadas: {{ novoTitulo.idsCategorias.length }}
        </small>
      </div>

      <div style="display: flex; justify-content: center; gap: 10px; margin-top: 20px;">
        <button type="button" class="btn-cancelar" (click)="fecharModalTitulo()">Cancelar</button>
        <button type="button" class="btn-salvar verde" (click)="salvarNovoTitulo()">Salvar t√≠tulo</button>
      </div>
    </div>
  </div>

 
  <div *ngIf="mostrarModalAutor" class="modal-overlay" (click)="fecharModalAutor()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h3>Cadastrar Novo Autor</h3>
      
      <div class="form-group">
        <label for="novoAutorNome">Nome do Autor: *</label>
        <input 
          type="text" 
          id="novoAutorNome" 
          name="novoAutorNome"
          [(ngModel)]="novoAutor.nome"
          placeholder="Digite o nome do autor"
          required
        />
      </div>

      <div style="display: flex; justify-content: center; gap: 10px; margin-top: 20px;">
        <button type="button" class="btn-cancelar" (click)="fecharModalAutor()">Cancelar</button>
        <button type="button" class="btn-salvar verde" (click)="salvarNovoAutor()">Salvar autor</button>
      </div>
    </div>
  </div>

  <div *ngIf="mostrarModalEditora" class="modal-overlay" (click)="fecharModalEditora()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h3>Cadastrar Nova Editora</h3>
      
      <div class="form-group">
        <label for="novaEditoraNome">Nome da Editora: *</label>
        <input 
          type="text" 
          id="novaEditoraNome" 
          name="novaEditoraNome"
          [(ngModel)]="novaEditora.nome"
          placeholder="Digite o nome da editora"
          required
        />
      </div>

      <div style="display: flex; justify-content: center; gap: 10px; margin-top: 20px;">
        <button type="button" class="btn-cancelar" (click)="fecharModalEditora()">Cancelar</button>
        <button type="button" class="btn-salvar verde" (click)="salvarNovaEditora()">Salvar editora</button>
      </div>
    </div>
  </div>

  <div *ngIf="mostrarModalIdioma" class="modal-overlay" (click)="fecharModalIdioma()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h3>Cadastrar Novo Idioma</h3>
      
      <div class="form-group">
        <label for="novoIdiomaNome">Nome do Idioma: *</label>
        <input 
          type="text" 
          id="novoIdiomaNome" 
          name="novoIdiomaNome"
          [(ngModel)]="novoIdioma.nome"
          placeholder="Digite o nome do idioma"
          required
        />
      </div>

      <div style="display: flex; justify-content: center; gap: 10px; margin-top: 20px;">
        <button type="button" class="btn-cancelar" (click)="fecharModalIdioma()">Cancelar</button>
        <button type="button" class="btn-salvar verde" (click)="salvarNovoIdioma()">Salvar idioma</button>
      </div>
    </div>
  </div>

  <div *ngIf="mostrarModalCategoria" class="modal-overlay" (click)="fecharModalCategoria()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h3>Cadastrar Nova Categoria</h3>
      
      <div class="form-group">
        <label for="novaCategoriaNome">Nome da Categoria: *</label>
        <input 
          type="text" 
          id="novaCategoriaNome" 
          name="novaCategoriaNome"
          [(ngModel)]="novaCategoria.nome"
          placeholder="Digite o nome da categoria"
          required
        />
      </div>

      <div style="display: flex; justify-content: center; gap: 10px; margin-top: 20px;">
        <button type="button" class="btn-cancelar" (click)="fecharModalCategoria()">Cancelar</button>
        <button type="button" class="btn-salvar verde" (click)="salvarNovaCategoria()">Salvar categoria</button>
      </div>
    </div>
  </div>
</div>

<style>
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }

  .modal-content {
    background-color: white;
    padding: 30px;
    border-radius: 8px;
    max-width: 500px;
    width: 90%;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .modal-content.modal-titulo {
    max-width: 600px;
    max-height: 85vh;
    overflow-y: auto;
  }

  .modal-content h3 {
    margin-top: 0;
    margin-bottom: 20px;
    color: #333;
  }

  .modal-content .form-group {
    margin-bottom: 15px;
  }

  .modal-content label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
    color: #555;
  }

  .modal-content input,
  .modal-content textarea {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
    box-sizing: border-box;
  }

  .modal-content textarea {
    resize: vertical;
    font-family: inherit;
  }

  .btn-cancelar {
    background-color: #ccc;
    border: none;
    color: #000;
    padding: 10px 20px;
    border-radius: 4px;
    cursor: pointer;
  }

  .btn-salvar {
    background-color: #f97316;
    border: none;
    color: white;
    padding: 10px 20px;
    border-radius: 4px;
    cursor: pointer;
  }
  .btn-salvar.verde {
    background-color: #16a34a; 
  }
  .btn-salvar.verde:hover {
    background-color: #15803d;
  }

  .btn-cancelar:hover {
    background-color: #bbb;
  }

  .btn-salvar:hover {
    background-color: #ea580c;
  }

  .checkbox-list {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 8px;
    background-color: #f9f9f9;
  }

  .checkbox-item {
    display: flex;
    align-items: center;
    padding: 8px 10px;
    margin-bottom: 4px;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.2s;
    background-color: white;
  }

  .checkbox-item:hover {
    background-color: #f0f0f0;
  }

  .checkbox-item.selected {
    background-color: #e0f2fe;
    border: 1px solid #0ea5e9;
  }

  .checkbox-item input[type="checkbox"] {
    margin-right: 8px;
    cursor: pointer;
    pointer-events: none;
  }

  .checkbox-item span {
    flex: 1;
    font-size: 14px;
    color: #333;
  }

  .checkbox-list-form {
    max-height: 180px;
    overflow-y: auto;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 8px;
    background-color: #f9f9f9;
  }

  .checkbox-list-form.disabled {
    background-color: #f5f5f5;
    opacity: 0.7;
    pointer-events: none;
  }

  .checkbox-item.disabled {
    cursor: not-allowed;
    opacity: 0.6;
  }

  .btn-add-novo {
    background-color: transparent;
    border: 1px solid #16a34a;
    color: #16a34a;
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 500;
    transition: all 0.2s;
  }

  .btn-add-novo:hover:not(:disabled) {
    background-color: #16a34a;
    color: white;
  }

  .btn-add-novo:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    border-color: #9ca3af;
    color: #9ca3af;
  }
</style>
