<div class="detalhes-cliente-root">
	<button class="btn btn-outline" type="button" (click)="onClose()">← Voltar</button>
	<h3>Detalhes do Cliente</h3>

	<div *ngIf="cliente; else noClient">
		<div class="detalhes-grid">
			<div class="left-col">
				<section class="section-card cliente-info">
					<h4>Dados do Cliente</h4>
					<dl>
						<dt>Nome</dt>
						<dd>{{ cliente.nome }}</dd>

						<dt>Email</dt>
						<dd>{{ cliente.email.endereco || cliente.username }}</dd>

						<dt>Telefone</dt>
						<dd>{{ cliente.telefone.numero || '—' }}</dd>

						<dt>CPF</dt>
						<dd>{{ cliente.cpf.valor || '—' }}</dd>

						<dt>Status</dt>
						<dd>{{ cliente.statusConta }}</dd>
					</dl>
					<div class="actions">
						<button
							*ngIf="cliente.statusConta !== 'INATIVA'"
							class="btn btn-primary" type="button" (click)="editarCliente()">Editar cliente</button>
						<button 
							*ngIf="isAdministrador() && cliente.statusConta !== 'INATIVA'" 
							class="btn btn-outline" 
							type="button"
							(click)="inativarCliente()">
							Inativar cliente
						</button>
					</div>

					<!-- Botões condicionais para aprovação/rejeição -->
					<div class="actions" *ngIf="cliente.statusConta === 'EM_ANALISE_APROVACAO'">
						<button class="btn btn-success" type="button" (click)="aprovarConta()">Aprovar Conta</button>
						<button class="btn btn-danger" type="button" (click)="abrirModalRejeicao()">Rejeitar Conta</button>
					</div>

					<!-- Botão condicional para solicitar exclusão -->
					<div class="actions" *ngIf="cliente.statusConta === 'ATIVA' && isBibliotecario()">
						<button class="btn btn-danger" type="button" (click)="abrirModalExclusao()">Solicitar Exclusão</button>
					</div>
				</section>

				<section class="section-card endereco-info">
					<h5>Endereço</h5>
					<dl>
						<dt>Rua</dt>
						<dd>{{ cliente.endereco?.rua || '—' }}</dd>

						<dt>Número</dt>
						<dd>{{ cliente.endereco?.numero || '—' }}</dd>

						<dt>Complemento</dt>
						<dd>{{ cliente.endereco?.complemento || '—' }}</dd>

						<dt>Bairro</dt>
						<dd>{{ cliente.endereco?.bairro || '—' }}</dd>

						<dt>Cidade / Estado</dt>
						<dd>{{ (cliente.endereco?.cidade || '—') + ' / ' + (cliente.endereco?.estado || '—') }}</dd>

						<dt>CEP</dt>
						<dd>{{ cliente.endereco?.cep || '—' }}</dd>
					</dl>
				</section>
			</div>

			<div class="right-col">
				<section class="section-card emprestimos-section">
					<h5>Empréstimos do cliente</h5>
					
					<div *ngIf="loadingEmprestimos" class="loading-msg">
						Carregando empréstimos...
					</div>

					<div *ngIf="errorEmprestimos" class="error-msg">
						{{ errorEmprestimos }}
					</div>

					<div *ngIf="!loadingEmprestimos && !errorEmprestimos">
						<div *ngIf="emprestimos.length > 0; else noEmprestimos">
							<div class="emprestimo-item" *ngFor="let emp of emprestimos">
								<div class="emp-header">
									<strong>Empréstimo #{{ emp.idEmprestimo }}</strong>
									<span class="emp-status" [class.status-ativo]="emp.status === 'ATIVO'">
										{{ emp.status }}
									</span>
								</div>
								<div class="emp-info">
									<span class="emp-label">Pessoa:</span>
									<span>{{ emp.idPessoa }}</span>
								</div>
								<div class="emp-info" *ngIf="emp.multa && emp.multa.valor > 0">
									<span class="emp-label">Multa:</span>
									<span class="multa-valor">R$ {{ emp.multa.valor }}</span>
								</div>
							</div>
						</div>
						<ng-template #noEmprestimos>
							<p class="muted">Nenhum empréstimo encontrado para este cliente.</p>
						</ng-template>
					</div>
				</section>
			</div>
		</div>
	</div>

	<ng-template #noClient>
		<p>Nenhum cliente selecionado.</p>
	</ng-template>

	<!-- Modal para rejeitar conta -->
	<div *ngIf="mostrarModalRejeicao" class="modal-overlay" (click)="fecharModalRejeicao()">
		<div class="modal-content" (click)="$event.stopPropagation()">
			<h3>Rejeitar Conta</h3>
			
			<div class="form-group">
				<label for="motivoRejeicao">Motivo da Rejeição: *</label>
				<textarea 
					id="motivoRejeicao" 
					name="motivoRejeicao"
					[(ngModel)]="motivoRejeicao"
					rows="4"
					placeholder="Digite o motivo da rejeição da conta..."
					minlength="8"
					required>
				</textarea>
				<small>Informe o motivo pelo qual a conta está sendo rejeitada (mínimo 8 caracteres).</small>
			</div>

			<div class="modal-actions">
				<button type="button" class="btn btn-outline" (click)="fecharModalRejeicao()">Cancelar</button>
				<button type="button" class="btn btn-danger" (click)="rejeitarConta()">Rejeitar Conta</button>
			</div>
		</div>
	</div>

	<!-- Modal para solicitar exclusão -->
	<div *ngIf="mostrarModalExclusao" class="modal-overlay" (click)="fecharModalExclusao()">
		<div class="modal-content" (click)="$event.stopPropagation()">
			<h3>Solicitar Exclusão</h3>
			
			<div class="form-group">
				<label for="motivoExclusao">Motivo da Exclusão: *</label>
				<textarea 
					id="motivoExclusao" 
					name="motivoExclusao"
					[(ngModel)]="motivoExclusao"
					rows="4"
					placeholder="Digite o motivo da solicitação de exclusão..."
					minlength="8"
					required>
				</textarea>
				<small>Informe o motivo pelo qual a exclusão está sendo solicitada (mínimo 8 caracteres).</small>
			</div>

			<div class="modal-actions">
				<button type="button" class="btn btn-outline" (click)="fecharModalExclusao()">Cancelar</button>
				<button type="button" class="btn btn-danger" (click)="solicitarExclusao()">Solicitar Exclusão</button>
			</div>
		</div>
	</div>

	<!-- Modal para inativar cliente -->
	<div *ngIf="mostrarModalInativacao" class="modal-overlay" (click)="fecharModalInativacao()">
		<div class="modal-content" (click)="$event.stopPropagation()">
			<h3>Inativar Cliente</h3>
			
			<div class="form-group">
				<label for="motivoInativacao">Motivo da Inativação: *</label>
				<textarea 
					id="motivoInativacao" 
					name="motivoInativacao"
					[(ngModel)]="motivoInativacao"
					rows="4"
					placeholder="Digite o motivo da inativação do cliente..."
					minlength="8"
					required>
				</textarea>
				<small>Informe o motivo pelo qual o cliente está sendo inativado (mínimo 8 caracteres).</small>
			</div>

			<div class="modal-actions">
				<button type="button" class="btn btn-outline" (click)="fecharModalInativacao()">Cancelar</button>
				<button type="button" class="btn btn-danger" (click)="confirmarInativacao()">Inativar Cliente</button>
			</div>
		</div>
	</div>
</div>
